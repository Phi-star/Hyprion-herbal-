<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hyprion Management ‚Äì Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --green-dark:#1a3d2b; --green-mid:#2d6a4f; --green-light:#52b788;
    --gold:#d4af37; --gold-light:#f0d060;
    --bg:#0f1f16; --bg-card:#182d20; --bg-card2:#1e3829;
    --text:#e8f5e9; --text-dim:#a5c4b0; --border:rgba(255,255,255,0.08);
    --error:#e74c3c; --success:#27ae60; --warning:#f39c12; --info:#3498db;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

  /* LOGIN */
  .login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse at 50% 0%,rgba(45,106,79,0.3) 0%,var(--bg) 60%);}
  .login-card{background:var(--bg-card);border-radius:24px;padding:50px 40px;width:100%;max-width:400px;border:1px solid var(--border);box-shadow:0 20px 60px rgba(0,0,0,0.5);animation:fade-in 0.5s ease;}
  .login-logo{font-family:'Playfair Display',serif;font-size:2rem;font-weight:900;color:white;text-align:center;margin-bottom:4px;}
  .login-logo span{color:var(--gold);}
  .login-subtitle{text-align:center;color:var(--text-dim);font-size:0.85rem;margin-bottom:36px;}
  .login-label{font-size:0.8rem;font-weight:600;color:var(--text-dim);margin-bottom:8px;display:block;text-transform:uppercase;letter-spacing:0.08em;}
  .login-input{width:100%;padding:14px 18px;background:rgba(255,255,255,0.06);border:2px solid var(--border);border-radius:12px;color:white;font-family:inherit;font-size:1rem;outline:none;transition:all 0.2s;margin-bottom:24px;letter-spacing:0.1em;}
  .login-input:focus{border-color:var(--green-light);background:rgba(255,255,255,0.09);}
  .login-btn{width:100%;padding:15px;background:linear-gradient(135deg,var(--green-mid),var(--green-dark));color:white;border:none;border-radius:12px;font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 20px rgba(45,106,79,0.4);}
  .login-btn:hover{transform:translateY(-2px);}
  .login-btn:disabled{opacity:0.6;cursor:not-allowed;transform:none;}
  .login-error{background:rgba(231,76,60,0.15);border:1px solid var(--error);color:#ff8a80;border-radius:10px;padding:12px 16px;font-size:0.85rem;margin-bottom:16px;display:none;text-align:center;}

  /* DASHBOARD */
  .dashboard{display:none;min-height:100vh;}
  .dash-topbar{background:var(--bg-card);border-bottom:1px solid var(--border);padding:16px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;}
  .dash-brand{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:900;color:white;}
  .dash-brand span{color:var(--gold);}
  .dash-topbar-right{display:flex;align-items:center;gap:16px;}
  .dash-badge{background:rgba(45,106,79,0.3);border:1px solid var(--green-light);color:var(--green-light);padding:5px 12px;border-radius:50px;font-size:0.78rem;font-weight:600;}
  .dash-logout-btn{background:rgba(231,76,60,0.15);border:1px solid rgba(231,76,60,0.3);color:#ff8a80;padding:8px 16px;border-radius:8px;cursor:pointer;font-family:inherit;font-size:0.85rem;font-weight:600;transition:all 0.2s;}
  .dash-logout-btn:hover{background:rgba(231,76,60,0.25);}
  .dash-main{padding:28px;max-width:1400px;margin:0 auto;}

  /* STATS */
  .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin-bottom:32px;}
  .stat-card{background:var(--bg-card);border-radius:16px;padding:24px;border:1px solid var(--border);position:relative;overflow:hidden;transition:all 0.3s;}
  .stat-card:hover{transform:translateY(-3px);}
  .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
  .stat-card.green::before{background:var(--green-light);}
  .stat-card.gold::before{background:var(--gold);}
  .stat-card.blue::before{background:var(--info);}
  .stat-card.orange::before{background:var(--warning);}
  .stat-icon{font-size:2rem;margin-bottom:12px;}
  .stat-value{font-family:'Playfair Display',serif;font-size:2.4rem;font-weight:900;color:white;line-height:1;margin-bottom:4px;}
  .stat-label{font-size:0.8rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.05em;}

  /* CONTROLS */
  .controls-bar{display:flex;align-items:center;gap:14px;margin-bottom:24px;flex-wrap:wrap;}
  .search-box{flex:1;min-width:200px;padding:11px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:inherit;font-size:0.9rem;outline:none;transition:border 0.2s;}
  .search-box:focus{border-color:var(--green-light);}
  .filter-select{padding:11px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:inherit;font-size:0.88rem;outline:none;cursor:pointer;}
  .ctrl-btn{padding:11px 18px;border-radius:10px;font-family:inherit;font-size:0.85rem;font-weight:600;cursor:pointer;border:1px solid var(--border);transition:all 0.2s;display:flex;align-items:center;gap:6px;}
  .ctrl-btn.primary{background:var(--green-mid);color:white;border-color:var(--green-mid);}
  .ctrl-btn.primary:hover{background:var(--green-dark);}
  .ctrl-btn.secondary{background:var(--bg-card);color:var(--text);}
  .ctrl-btn.secondary:hover{background:var(--bg-card2);}

  /* TABLE */
  .table-card{background:var(--bg-card);border-radius:20px;border:1px solid var(--border);overflow:hidden;}
  .table-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
  .table-header h2{font-size:1.1rem;font-weight:700;}
  .table-count{font-size:0.8rem;color:var(--text-dim);}
  .orders-table{width:100%;border-collapse:collapse;}
  .orders-table th{padding:14px 16px;text-align:left;font-size:0.75rem;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.08em;border-bottom:1px solid var(--border);background:rgba(0,0,0,0.2);}
  .orders-table td{padding:14px 16px;font-size:0.88rem;border-bottom:1px solid rgba(255,255,255,0.04);vertical-align:middle;}
  .orders-table tr:last-child td{border-bottom:none;}
  .orders-table tr:hover td{background:rgba(255,255,255,0.03);}
  .order-id{font-weight:700;color:var(--gold);font-family:monospace;font-size:0.85rem;}
  .customer-name{font-weight:600;color:white;}
  .customer-contact{font-size:0.8rem;color:var(--text-dim);}
  .status-badge{padding:4px 10px;border-radius:50px;font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;}
  .status-new{background:rgba(52,152,219,0.2);color:#5dade2;border:1px solid rgba(52,152,219,0.3);}
  .status-confirmed{background:rgba(39,174,96,0.2);color:#58d68d;border:1px solid rgba(39,174,96,0.3);}
  .status-shipped{background:rgba(243,156,18,0.2);color:#f5b041;border:1px solid rgba(243,156,18,0.3);}
  .status-delivered{background:rgba(82,183,136,0.2);color:var(--green-light);border:1px solid rgba(82,183,136,0.3);}
  .status-cancelled{background:rgba(231,76,60,0.2);color:#ec7063;border:1px solid rgba(231,76,60,0.3);}
  .action-btn{padding:6px 12px;border-radius:6px;font-size:0.78rem;font-weight:600;cursor:pointer;border:none;margin:0 2px;transition:all 0.2s;font-family:inherit;}
  .action-view{background:rgba(52,152,219,0.2);color:#5dade2;}
  .action-view:hover{background:rgba(52,152,219,0.35);}
  .action-confirm{background:rgba(39,174,96,0.2);color:#58d68d;}
  .action-confirm:hover{background:rgba(39,174,96,0.35);}
  .empty-state{text-align:center;padding:60px 20px;color:var(--text-dim);}
  .empty-state .empty-icon{font-size:3rem;margin-bottom:16px;}

  /* MODAL */
  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;align-items:center;justify-content:center;}
  .modal-overlay.show{display:flex;}
  .modal-box{background:var(--bg-card);border-radius:20px;padding:36px;max-width:560px;width:90%;border:1px solid var(--border);animation:scale-in 0.3s ease;max-height:85vh;overflow-y:auto;}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;}
  .modal-title{font-family:'Playfair Display',serif;font-size:1.3rem;color:white;}
  .modal-close{width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,0.1);color:var(--text-dim);border:none;cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center;transition:all 0.2s;}
  .modal-close:hover{background:rgba(231,76,60,0.3);color:#ff8a80;}
  .modal-section{margin-bottom:20px;}
  .modal-section-title{font-size:0.72rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--green-light);font-weight:700;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border);}
  .modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  .modal-field label{font-size:0.75rem;color:var(--text-dim);font-weight:600;display:block;margin-bottom:3px;}
  .modal-field span{font-size:0.9rem;color:white;}
  .status-change-select{padding:10px 14px;background:rgba(255,255,255,0.06);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:inherit;width:100%;outline:none;cursor:pointer;margin-bottom:14px;}
  .modal-actions{display:flex;gap:10px;margin-top:20px;}
  .modal-save-btn{flex:1;padding:13px;background:var(--green-mid);color:white;border:none;border-radius:10px;font-family:inherit;font-weight:700;cursor:pointer;transition:all 0.2s;}
  .modal-save-btn:hover{background:var(--green-dark);}
  .modal-del-btn{padding:13px 20px;background:rgba(231,76,60,0.15);color:#ff8a80;border:1px solid rgba(231,76,60,0.3);border-radius:10px;font-family:inherit;font-weight:700;cursor:pointer;}
  .modal-del-btn:hover{background:rgba(231,76,60,0.25);}

  /* TOAST */
  .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--bg-card2);border:1px solid var(--border);border-radius:12px;padding:14px 24px;font-size:0.9rem;font-weight:600;z-index:99999;transition:transform 0.3s ease;white-space:nowrap;box-shadow:0 8px 30px rgba(0,0,0,0.4);}
  .toast.show{transform:translateX(-50%) translateY(0);}
  .toast.success{border-color:var(--green-light);color:var(--green-light);}
  .toast.error{border-color:var(--error);color:#ff8a80;}

  .refresh-indicator{font-size:0.78rem;color:var(--text-dim);display:flex;align-items:center;gap:6px;}
  .live-dot{width:8px;height:8px;background:var(--green-light);border-radius:50%;animation:pulse-dot 2s ease infinite;}

  @keyframes fade-in{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
  @keyframes scale-in{from{transform:scale(0.85);opacity:0;}to{transform:scale(1);opacity:1;}}
  @keyframes pulse-dot{0%{box-shadow:0 0 0 0 rgba(82,183,136,0.7);}70%{box-shadow:0 0 0 6px rgba(82,183,136,0);}100%{box-shadow:0 0 0 0 rgba(82,183,136,0);}}

  @media(max-width:768px){
    .dash-main{padding:16px;}
    .stats-row{grid-template-columns:1fr 1fr;}
    .orders-table{font-size:0.8rem;}
    .modal-grid{grid-template-columns:1fr;}
  }
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <div class="login-logo">Hyp<span>rion</span></div>
    <div class="login-subtitle">üîí Admin Management Portal</div>
    <div class="login-error" id="loginError">‚ö†Ô∏è Invalid password. Please try again.</div>
    <label class="login-label">Admin Password</label>
    <input type="password" class="login-input" id="passwordInput" placeholder="Enter password..." onkeydown="if(event.key==='Enter')doLogin()">
    <button class="login-btn" id="loginBtn" onclick="doLogin()">üîì Access Dashboard</button>
  </div>
</div>

<!-- DASHBOARD -->
<div class="dashboard" id="dashboard">
  <div class="dash-topbar">
    <div class="dash-brand">Hyp<span>rion</span> Admin</div>
    <div class="dash-topbar-right">
      <div class="refresh-indicator"><div class="live-dot"></div><span id="lastRefresh">Live</span></div>
      <div class="dash-badge">üîê Authenticated</div>
      <button class="dash-logout-btn" onclick="doLogout()">Logout</button>
    </div>
  </div>

  <div class="dash-main">
    <!-- STATS -->
    <div class="stats-row">
      <div class="stat-card green"><div class="stat-icon">üì¶</div><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total Orders</div></div>
      <div class="stat-card blue"><div class="stat-icon">üÜï</div><div class="stat-value" id="statNew">0</div><div class="stat-label">New</div></div>
      <div class="stat-card gold"><div class="stat-icon">‚úÖ</div><div class="stat-value" id="statConfirmed">0</div><div class="stat-label">Confirmed</div></div>
      <div class="stat-card orange"><div class="stat-icon">üöö</div><div class="stat-value" id="statShipped">0</div><div class="stat-label">Shipped</div></div>
      <div class="stat-card green"><div class="stat-icon">üéâ</div><div class="stat-value" id="statDelivered">0</div><div class="stat-label">Delivered</div></div>
    </div>

    <!-- CONTROLS -->
    <div class="controls-bar">
      <input type="text" class="search-box" id="searchBox" placeholder="üîç Search name, phone, location..." oninput="renderOrders()">
      <select class="filter-select" id="statusFilter" onchange="renderOrders()">
        <option value="">All Statuses</option>
        <option>New</option><option>Confirmed</option><option>Shipped</option><option>Delivered</option><option>Cancelled</option>
      </select>
      <select class="filter-select" id="sortFilter" onchange="renderOrders()">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
      </select>
      <button class="ctrl-btn primary" onclick="fetchOrders()">üîÑ Refresh</button>
      <button class="ctrl-btn secondary" onclick="exportCSV()">üì• Export CSV</button>
    </div>

    <!-- TABLE -->
    <div class="table-card">
      <div class="table-header">
        <h2>üìã Orders</h2>
        <span class="table-count" id="tableCount">Loading...</span>
      </div>
      <div style="overflow-x:auto">
        <table class="orders-table">
          <thead>
            <tr>
              <th>Order ID</th><th>Customer</th><th>Phone</th>
              <th>Package</th><th>Location</th><th>Date</th><th>Status</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="ordersTableBody">
            <tr><td colspan="8"><div class="empty-state"><div class="empty-icon">‚è≥</div><p>Loading orders...</p></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ORDER MODAL -->
<div class="modal-overlay" id="orderModal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">üì¶ Order Details</div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-section">
      <div class="modal-section-title">Order Info</div>
      <div class="modal-grid">
        <div class="modal-field"><label>Order ID</label><span id="mOrderId">‚Äî</span></div>
        <div class="modal-field"><label>Date / Time</label><span id="mOrderDate">‚Äî</span></div>
        <div class="modal-field"><label>Package</label><span id="mPackage">‚Äî</span></div>
        <div class="modal-field"><label>Source</label><span id="mSource">‚Äî</span></div>
      </div>
    </div>
    <div class="modal-section">
      <div class="modal-section-title">Customer</div>
      <div class="modal-grid">
        <div class="modal-field"><label>Full Name</label><span id="mName">‚Äî</span></div>
        <div class="modal-field"><label>Phone</label><span id="mPhone">‚Äî</span></div>
        <div class="modal-field"><label>WhatsApp</label><span id="mWhatsapp">‚Äî</span></div>
        <div class="modal-field"><label>Email</label><span id="mEmail">‚Äî</span></div>
      </div>
    </div>
    <div class="modal-section">
      <div class="modal-section-title">Delivery</div>
      <div class="modal-grid">
        <div class="modal-field"><label>State</label><span id="mState">‚Äî</span></div>
        <div class="modal-field"><label>City / LGA</label><span id="mCity">‚Äî</span></div>
        <div class="modal-field" style="grid-column:1/-1"><label>Full Address</label><span id="mAddress">‚Äî</span></div>
        <div class="modal-field" style="grid-column:1/-1"><label>Notes</label><span id="mNotes">‚Äî</span></div>
      </div>
    </div>
    <div class="modal-section">
      <div class="modal-section-title">Update Status</div>
      <select class="status-change-select" id="statusChangeSelect">
        <option>New</option><option>Confirmed</option><option>Shipped</option><option>Delivered</option><option>Cancelled</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="modal-save-btn" onclick="updateOrderStatus()">‚úÖ Update Status</button>
      <button class="modal-del-btn" onclick="deleteOrder()">üóëÔ∏è Delete</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// =====================================================
// STATE
// =====================================================
let adminToken    = null;   // real JWT from server
let currentOrders = [];
let currentOrderId = null;
let refreshInterval = null;

const TOKEN_KEY = 'hyprion_jwt';

// =====================================================
// AUTH HELPERS
// =====================================================
function saveToken(token) {
  adminToken = token;
  localStorage.setItem(TOKEN_KEY, token);
}

function loadToken() {
  adminToken = localStorage.getItem(TOKEN_KEY);
  return adminToken;
}

function clearToken() {
  adminToken = null;
  localStorage.removeItem(TOKEN_KEY);
}

// Headers for every protected API call
function authHeaders(extra) {
  return Object.assign({ 'Authorization': `Bearer ${adminToken}`, 'Content-Type': 'application/json' }, extra || {});
}

// =====================================================
// LOGIN ‚Äî calls server POST /api/hyprion-admin-login
// Gets back a real JWT and stores it
// =====================================================
async function doLogin() {
  const pw  = document.getElementById('passwordInput').value.trim();
  const btn = document.getElementById('loginBtn');
  const err = document.getElementById('loginError');

  if (!pw) return;

  btn.disabled    = true;
  btn.textContent = 'Logging in...';
  err.style.display = 'none';

  try {
    const resp = await fetch('/api/hyprion-admin-login', {
      method:  'POST',
      headers: { 'Content-Type': 'application/json' },
      body:    JSON.stringify({ password: pw })
    });

    const data = await resp.json();

    if (resp.ok && data.success && data.token) {
      saveToken(data.token);
      showDashboard();
    } else {
      err.textContent   = '‚ö†Ô∏è ' + (data.message || 'Invalid password.');
      err.style.display = 'block';
      document.getElementById('passwordInput').value = '';
      setTimeout(() => err.style.display = 'none', 4000);
    }
  } catch (e) {
    err.textContent   = '‚ö†Ô∏è Connection error. Check server.';
    err.style.display = 'block';
  }

  btn.disabled    = false;
  btn.textContent = 'üîì Access Dashboard';
}

function showDashboard() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('dashboard').style.display   = 'block';
  fetchOrders();
  startAutoRefresh();
}

function doLogout() {
  clearToken();
  if (refreshInterval) clearInterval(refreshInterval);
  document.getElementById('dashboard').style.display   = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
}

// =====================================================
// ON PAGE LOAD ‚Äî restore session from localStorage
// Verify with server to confirm token is still valid
// =====================================================
window.addEventListener('load', async () => {
  const token = loadToken();
  if (!token) return; // show login

  try {
    const resp = await fetch('/api/hyprion-verify-session', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (resp.ok) {
      const data = await resp.json();
      if (data.success) {
        showDashboard();
        return;
      }
    }
    // Token invalid/expired ‚Äî clear and show login
    clearToken();
  } catch (e) {
    // Server unreachable ‚Äî still show login
    clearToken();
  }
});

// =====================================================
// FETCH ORDERS
// =====================================================
async function fetchOrders() {
  try {
    const resp = await fetch('/api/hyprion-orders', { headers: authHeaders() });

    if (resp.status === 401) {
      showToast('Session expired. Please login again.', 'error');
      setTimeout(doLogout, 1500);
      return;
    }

    const data = await resp.json();
    if (data.success) {
      currentOrders = data.orders || [];
      updateStats();
      renderOrders();
      document.getElementById('lastRefresh').textContent = 'Updated ' + new Date().toLocaleTimeString();
    } else {
      showToast('‚ö†Ô∏è ' + (data.message || 'Failed to load orders'), 'error');
    }
  } catch (err) {
    showToast('‚ö†Ô∏è Network error: ' + err.message, 'error');
  }
}

// =====================================================
// STATS
// =====================================================
function updateStats() {
  document.getElementById('statTotal').textContent     = currentOrders.length;
  document.getElementById('statNew').textContent       = currentOrders.filter(o => o.status === 'New').length;
  document.getElementById('statConfirmed').textContent = currentOrders.filter(o => o.status === 'Confirmed').length;
  document.getElementById('statShipped').textContent   = currentOrders.filter(o => o.status === 'Shipped').length;
  document.getElementById('statDelivered').textContent = currentOrders.filter(o => o.status === 'Delivered').length;
}

// =====================================================
// RENDER TABLE
// =====================================================
function renderOrders() {
  const search = document.getElementById('searchBox').value.toLowerCase();
  const sf     = document.getElementById('statusFilter').value;
  const sort   = document.getElementById('sortFilter').value;

  let list = currentOrders.filter(o => {
    const ms = !search || (o.fullName||'').toLowerCase().includes(search) ||
               (o.phone||'').includes(search) || (o.state||'').toLowerCase().includes(search) ||
               (o.city||'').toLowerCase().includes(search) || (o.orderId||'').toLowerCase().includes(search);
    const mf = !sf || o.status === sf;
    return ms && mf;
  });

  list.sort((a,b) => sort === 'newest'
    ? new Date(b.timestamp) - new Date(a.timestamp)
    : new Date(a.timestamp) - new Date(b.timestamp));

  document.getElementById('tableCount').textContent = `Showing ${list.length} of ${currentOrders.length} orders`;

  const tbody = document.getElementById('ordersTableBody');
  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">üì≠</div><p>No orders found.</p></div></td></tr>`;
    return;
  }

  tbody.innerHTML = list.map(o => `
    <tr>
      <td><span class="order-id">${o.orderId||'‚Äî'}</span></td>
      <td><div class="customer-name">${esc(o.fullName)}</div></td>
      <td>
        <div>${esc(o.phone)}</div>
        ${o.whatsapp ? `<div class="customer-contact">WA: ${esc(o.whatsapp)}</div>` : ''}
      </td>
      <td>${esc(o.package||'‚Äî')}</td>
      <td><div>${esc(o.state)}</div><div class="customer-contact">${esc(o.city)}</div></td>
      <td>${fmtDate(o.timestamp)}</td>
      <td><span class="status-badge status-${(o.status||'new').toLowerCase()}">${o.status||'New'}</span></td>
      <td>
        <button class="action-btn action-view" onclick="viewOrder('${o.orderId}')">View</button>
        <button class="action-btn action-confirm" onclick="quickConfirm('${o.orderId}')">Confirm</button>
      </td>
    </tr>`).join('');
}

// =====================================================
// ORDER MODAL
// =====================================================
function viewOrder(id) {
  const o = currentOrders.find(x => x.orderId === id);
  if (!o) return;
  currentOrderId = id;
  document.getElementById('mOrderId').textContent   = o.orderId   || '‚Äî';
  document.getElementById('mOrderDate').textContent = new Date(o.timestamp).toLocaleString();
  document.getElementById('mPackage').textContent   = o.package   || '‚Äî';
  document.getElementById('mSource').textContent    = o.source    || '‚Äî';
  document.getElementById('mName').textContent      = o.fullName  || '‚Äî';
  document.getElementById('mPhone').textContent     = o.phone     || '‚Äî';
  document.getElementById('mWhatsapp').textContent  = o.whatsapp  || '‚Äî';
  document.getElementById('mEmail').textContent     = o.email     || '‚Äî';
  document.getElementById('mState').textContent     = o.state     || '‚Äî';
  document.getElementById('mCity').textContent      = o.city      || '‚Äî';
  document.getElementById('mAddress').textContent   = o.address   || '‚Äî';
  document.getElementById('mNotes').textContent     = o.notes     || '(none)';
  document.getElementById('statusChangeSelect').value = o.status || 'New';
  document.getElementById('orderModal').classList.add('show');
}

function closeModal() {
  document.getElementById('orderModal').classList.remove('show');
  currentOrderId = null;
}

async function updateOrderStatus() {
  if (!currentOrderId) return;
  const status = document.getElementById('statusChangeSelect').value;
  try {
    const resp = await fetch(`/api/hyprion-order/${currentOrderId}`, {
      method:  'PATCH',
      headers: authHeaders(),
      body:    JSON.stringify({ status })
    });
    const data = await resp.json();
    if (data.success) {
      const o = currentOrders.find(x => x.orderId === currentOrderId);
      if (o) o.status = status;
      updateStats(); renderOrders(); closeModal();
      showToast('‚úÖ Status updated to ' + status, 'success');
    } else {
      showToast('‚ùå ' + (data.message || 'Update failed'), 'error');
    }
  } catch (e) {
    showToast('‚ùå Network error', 'error');
  }
}

async function deleteOrder() {
  if (!currentOrderId || !confirm('Delete this order permanently?')) return;
  try {
    const resp = await fetch(`/api/hyprion-order/${currentOrderId}`, {
      method: 'DELETE', headers: authHeaders()
    });
    const data = await resp.json();
    if (data.success) {
      currentOrders = currentOrders.filter(o => o.orderId !== currentOrderId);
      updateStats(); renderOrders(); closeModal();
      showToast('üóëÔ∏è Order deleted', 'success');
    } else {
      showToast('‚ùå ' + (data.message || 'Delete failed'), 'error');
    }
  } catch (e) {
    showToast('‚ùå Network error', 'error');
  }
}

async function quickConfirm(id) {
  try {
    const resp = await fetch(`/api/hyprion-order/${id}`, {
      method: 'PATCH', headers: authHeaders(), body: JSON.stringify({ status: 'Confirmed' })
    });
    const data = await resp.json();
    if (data.success) {
      const o = currentOrders.find(x => x.orderId === id);
      if (o) o.status = 'Confirmed';
      updateStats(); renderOrders();
      showToast('‚úÖ Order confirmed!', 'success');
    } else {
      showToast('‚ùå ' + (data.message||'Failed'), 'error');
    }
  } catch (e) {
    showToast('‚ùå Network error', 'error');
  }
}

// =====================================================
// EXPORT CSV
// =====================================================
function exportCSV() {
  const headers = ['Order ID','Name','Phone','WhatsApp','Email','Package','State','City','Address','Notes','Source','Status','Date'];
  const rows = currentOrders.map(o => [
    o.orderId,o.fullName,o.phone,o.whatsapp,o.email,o.package,
    o.state,o.city,o.address,o.notes,o.source,o.status,
    new Date(o.timestamp).toLocaleString()
  ].map(v => `"${(v||'').toString().replace(/"/g,'""')}"`));
  const csv  = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
  const a    = document.createElement('a');
  a.href     = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download = `hyprion_orders_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  showToast('üì• CSV exported', 'success');
}

// =====================================================
// AUTO REFRESH
// =====================================================
function startAutoRefresh() {
  if (refreshInterval) clearInterval(refreshInterval);
  refreshInterval = setInterval(fetchOrders, 60000);
}

// =====================================================
// TOAST
// =====================================================
let toastT;
function showToast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  clearTimeout(toastT);
  toastT = setTimeout(() => t.classList.remove('show'), 3500);
}

// =====================================================
// HELPERS
// =====================================================
function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function fmtDate(ts) {
  if (!ts) return '‚Äî';
  const d = new Date(ts);
  return d.toLocaleDateString('en-NG',{day:'2-digit',month:'short',year:'numeric'}) + ' ' +
         d.toLocaleTimeString('en-NG',{hour:'2-digit',minute:'2-digit'});
}

document.getElementById('orderModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
</script>
</body>
</html>
